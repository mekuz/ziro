
<!DOCTYPE html>
<html>
	<head>
		<title>ZION ROBOTICS- Robotics Development Software for Children</title>
		

		<script src="blockly_compressed.js"></script>
		<script src="blocks_compressed.js"></script>
		
		<script src="javascript_compressed.js"></script>
		<script src="python_compressed.js"></script>

		<script src="msg/js/en.js"></script>

		<!--script src="custom_dialog.js"></script-->
		
	</head>
	<body>
		
		<div id="blockly-div" style=" height : 400px;  width : 100%; border:2px solid black; background: white  ">
		</div> <! end--block area-->
		
		<div>
			Port<span id="port-details"></span><br>
			<label for="select-port">Set Port</label>
			<select name="select-port" id="select-port"></select>
			<button id="get-port-btn">Get Available Ports</button>
			<button id="scan-ble-btn">Scan BLE</button>
			<button id="toggle">TOGGLE</button>
		</div>
		
			<div id="o-js">
				<textarea name="code" id="op-js" disable>
				</textarea>
			</div>
			<div id="o-py">
				<textarea name="code" id="op-py" disable>
				</textarea>
			</div>
         
         <button id="runBtn" onclick="runCode()">Run</button>
		 
		
		<script>
			let ipc = window.ipcRenderer;
		</script>

		<!--- for js live processing using an interpreter------>
		<script src="js/acorn_interpreter.js"></script>
		<script src="funcs.js"></script>
		
		<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
		  <category name="Input/Output" colour="#9fa55b">
			<block type="io_digital_write">
			  <field name="pin number">0</field>
			  <field name="pin value">HIGH</field>
			</block>
			<block type="io_digital_read">
			  <field name="pin name">2</field>
			</block>
			<block type="io_get_distance">
			</block>
		  </category>
		  <sep></sep>
		  <category name="Logic" colour="#5b80a5">
			<block type="controls_if"></block>
			<block type="logic_compare">
			  <field name="OP">EQ</field>
			</block>
			<block type="logic_operation">
			  <field name="OP">AND</field>
			</block>
			<block type="logic_negate"></block>
			<block type="logic_boolean">
			  <field name="BOOL">TRUE</field>
			</block>
			<block type="logic_null"></block>
			<block type="logic_ternary"></block>
		  </category>
		  <category name="Control" colour="#5ba55b">
			<block type="start_block"></block>
			<block type="controls_repeat_ext">
			  <value name="TIMES">
				<shadow type="math_number">
				  <field name="NUM">10</field>
				</shadow>
			  </value>
			</block>
			<block type="controls_whileUntil">
			  <field name="MODE">WHILE</field>
			</block>
			<block type="wait">
			  <field name="NAME">1</field>
			</block>
			<block type="controls_if"></block>
		  </category>
		  <category name="Math" colour="#5b67a5">
			<block type="math_number">
			  <field name="NUM">0</field>
			</block>
			<block type="math_arithmetic">
			  <field name="OP">ADD</field>
			  <value name="A">
				<shadow type="math_number">
				  <field name="NUM">1</field>
				</shadow>
			  </value>
			  <value name="B">
				<shadow type="math_number">
				  <field name="NUM">1</field>
				</shadow>
			  </value>
			</block>
			<block type="math_single">
			  <field name="OP">ROOT</field>
			  <value name="NUM">
				<shadow type="math_number">
				  <field name="NUM">9</field>
				</shadow>
			  </value>
			</block>
			<block type="math_trig">
			  <field name="OP">SIN</field>
			  <value name="NUM">
				<shadow type="math_number">
				  <field name="NUM">45</field>
				</shadow>
			  </value>
			</block>
			<block type="math_constant">
			  <field name="CONSTANT">PI</field>
			</block>
			<block type="math_number_property">
			  <mutation divisor_input="false"></mutation>
			  <field name="PROPERTY">EVEN</field>
			  <value name="NUMBER_TO_CHECK">
				<shadow type="math_number">
				  <field name="NUM">0</field>
				</shadow>
			  </value>
			</block>
			<block type="math_round">
			  <field name="OP">ROUND</field>
			  <value name="NUM">
				<shadow type="math_number">
				  <field name="NUM">3.1</field>
				</shadow>
			  </value>
			</block>
			<block type="math_on_list">
			  <mutation op="SUM"></mutation>
			  <field name="OP">SUM</field>
			</block>
			<block type="math_modulo">
			  <value name="DIVIDEND">
				<shadow type="math_number">
				  <field name="NUM">64</field>
				</shadow>
			  </value>
			  <value name="DIVISOR">
				<shadow type="math_number">
				  <field name="NUM">10</field>
				</shadow>
			  </value>
			</block>
			<block type="math_constrain">
			  <value name="VALUE">
				<shadow type="math_number">
				  <field name="NUM">50</field>
				</shadow>
			  </value>
			  <value name="LOW">
				<shadow type="math_number">
				  <field name="NUM">1</field>
				</shadow>
			  </value>
			  <value name="HIGH">
				<shadow type="math_number">
				  <field name="NUM">100</field>
				</shadow>
			  </value>
			</block>
			<block type="math_random_int">
			  <value name="FROM">
				<shadow type="math_number">
				  <field name="NUM">1</field>
				</shadow>
			  </value>
			  <value name="TO">
				<shadow type="math_number">
				  <field name="NUM">100</field>
				</shadow>
			  </value>
			</block>
			<block type="math_random_float"></block>
		  </category>
		  <category name="Text" colour="#5ba58c">
			<block type="text">
			  <field name="TEXT"></field>
			</block>
			<block type="text_join">
			  <mutation items="2"></mutation>
			</block>
			<block type="text_append">
			  <field name="VAR" id="6bW.~.n8;[R5uU`fGDOs">item</field>
			  <value name="TEXT">
				<shadow type="text">
				  <field name="TEXT"></field>
				</shadow>
			  </value>
			</block>
			<block type="text_length">
			  <value name="VALUE">
				<shadow type="text">
				  <field name="TEXT">abc</field>
				</shadow>
			  </value>
			</block>
			<block type="text_isEmpty">
			  <value name="VALUE">
				<shadow type="text">
				  <field name="TEXT"></field>
				</shadow>
			  </value>
			</block>
			<block type="text_indexOf">
			  <field name="END">FIRST</field>
			  <value name="VALUE">
				<block type="variables_get">
				  <field name="VAR" id="crN^N_{?rUn2;TC1tr;1">text</field>
				</block>
			  </value>
			  <value name="FIND">
				<shadow type="text">
				  <field name="TEXT">abc</field>
				</shadow>
			  </value>
			</block>
			<block type="text_charAt">
			  <mutation at="true"></mutation>
			  <field name="WHERE">FROM_START</field>
			  <value name="VALUE">
				<block type="variables_get">
				  <field name="VAR" id="crN^N_{?rUn2;TC1tr;1">text</field>
				</block>
			  </value>
			</block>
			<block type="text_getSubstring">
			  <mutation at1="true" at2="true"></mutation>
			  <field name="WHERE1">FROM_START</field>
			  <field name="WHERE2">FROM_START</field>
			  <value name="STRING">
				<block type="variables_get">
				  <field name="VAR" id="crN^N_{?rUn2;TC1tr;1">text</field>
				</block>
			  </value>
			</block>
			<block type="text_changeCase">
			  <field name="CASE">UPPERCASE</field>
			  <value name="TEXT">
				<shadow type="text">
				  <field name="TEXT">abc</field>
				</shadow>
			  </value>
			</block>
			<block type="text_trim">
			  <field name="MODE">BOTH</field>
			  <value name="TEXT">
				<shadow type="text">
				  <field name="TEXT">abc</field>
				</shadow>
			  </value>
			</block>
			<block type="text_print">
			  <value name="TEXT">
				<shadow type="text">
				  <field name="TEXT">abc</field>
				</shadow>
			  </value>
			</block>
			<block type="text_prompt_ext">
			  <mutation type="TEXT"></mutation>
			  <field name="TYPE">TEXT</field>
			  <value name="TEXT">
				<shadow type="text">
				  <field name="TEXT">abc</field>
				</shadow>
			  </value>
			</block>
		  </category>
		  <category name="Colour" colour="#a5745b">
			<block type="colour_picker">
			  <field name="COLOUR">#ff0000</field>
			</block>
			<block type="colour_random"></block>
			<block type="colour_rgb">
			  <value name="RED">
				<shadow type="math_number">
				  <field name="NUM">100</field>
				</shadow>
			  </value>
			  <value name="GREEN">
				<shadow type="math_number">
				  <field name="NUM">50</field>
				</shadow>
			  </value>
			  <value name="BLUE">
				<shadow type="math_number">
				  <field name="NUM">0</field>
				</shadow>
			  </value>
			</block>
			<block type="colour_blend">
			  <value name="COLOUR1">
				<shadow type="colour_picker">
				  <field name="COLOUR">#ff0000</field>
				</shadow>
			  </value>
			  <value name="COLOUR2">
				<shadow type="colour_picker">
				  <field name="COLOUR">#3333ff</field>
				</shadow>
			  </value>
			  <value name="RATIO">
				<shadow type="math_number">
				  <field name="NUM">0.5</field>
				</shadow>
			  </value>
			</block>
		  </category>
		  <sep></sep>
		  <category name="Lists" colour="#745ba5">
			<block type="lists_create_with">
			  <mutation items="0"></mutation>
			</block>
			<block type="lists_create_with">
			  <mutation items="3"></mutation>
			</block>
			<block type="lists_repeat">
			  <value name="NUM">
				<shadow type="math_number">
				  <field name="NUM">5</field>
				</shadow>
			  </value>
			</block>
			<block type="lists_length"></block>
			<block type="lists_isEmpty"></block>
			<block type="lists_indexOf">
			  <field name="END">FIRST</field>
			  <value name="VALUE">
				<block type="variables_get">
				  <field name="VAR" id="8nIf,A2UQS@QuZGS4VH`">list</field>
				</block>
			  </value>
			</block>
			<block type="lists_getIndex">
			  <mutation statement="false" at="true"></mutation>
			  <field name="MODE">GET</field>
			  <field name="WHERE">FROM_START</field>
			  <value name="VALUE">
				<block type="variables_get">
				  <field name="VAR" id="8nIf,A2UQS@QuZGS4VH`">list</field>
				</block>
			  </value>
			</block>
			<block type="lists_setIndex">
			  <mutation at="true"></mutation>
			  <field name="MODE">SET</field>
			  <field name="WHERE">FROM_START</field>
			  <value name="LIST">
				<block type="variables_get">
				  <field name="VAR" id="8nIf,A2UQS@QuZGS4VH`">list</field>
				</block>
			  </value>
			</block>
			<block type="lists_getSublist">
			  <mutation at1="true" at2="true"></mutation>
			  <field name="WHERE1">FROM_START</field>
			  <field name="WHERE2">FROM_START</field>
			  <value name="LIST">
				<block type="variables_get">
				  <field name="VAR" id="8nIf,A2UQS@QuZGS4VH`">list</field>
				</block>
			  </value>
			</block>
			<block type="lists_split">
			  <mutation mode="SPLIT"></mutation>
			  <field name="MODE">SPLIT</field>
			  <value name="DELIM">
				<shadow type="text">
				  <field name="TEXT">,</field>
				</shadow>
			  </value>
			</block>
			<block type="lists_sort">
			  <field name="TYPE">NUMERIC</field>
			  <field name="DIRECTION">1</field>
			</block>
		  </category>
		  <category name="Variables" colour="#a55b80" custom="VARIABLE"></category>
		  <category name="Functions" colour="#995ba5" custom="PROCEDURE"></category>
		</xml>
		
		<xml xmlns="https://developers.google.com/blockly/xml" id="freshWorkspaceBlocks" style="display: none">
		  <block type="start_block" id="Eh|_K?8=dspdEFDUp~|J" x="113" y="88"></block>
		</xml>
		
		
		<script src="zi def.js"></script>
		<script src="zi gen js.js"></script>
		<script src="zi gen python.js"></script>

		<script>
		
				//custom blocks
		/* TODO: Change toolbox XML ID if necessary. Can export toolbox XML from Workspace Factory. */
		var toolbox = document.getElementById("toolbox");

		var options = { 
			toolbox : toolbox, 
			collapse : true, 
			comments : true, 
			disable : true, 
			maxBlocks : Infinity, 
			trashcan : true, 
			horizontalLayout : false, 
			toolboxPosition : 'start', 
			css : true, 
			media : 'atom://public/blockly_media/', 
			rtl : false, 
			scrollbars : true, 
			sounds : true, 
			oneBasedIndex : true
		};

		/* Inject your workspace */ 
		var workspace = Blockly.inject('blockly-div', options);

		/* Load Workspace Blocks from XML to workspace. Remove all code below if no blocks to load */

		/* TODO: Change workspace blocks XML ID if necessary. Can export workspace blocks XML from Workspace Factory. */
		function freshWorkspace(){
			Blockly.mainWorkspace.clear();
			var workspaceBlocks = document.getElementById("freshWorkspaceBlocks"); 

			/* Load blocks to workspace. */
			Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);
		}

		let inMode;//the input modes of some pins or ports, so we know 
		//which inputs to poll with analogRead and which to poll as distance
			  
		function myUpdateFunction(event) {
			//initialize inMode to a new object
			inMode=  Object.create(null);
			//convert the workspace to javascript code
		 	var jsCode = Blockly.JavaScript.workspaceToCode(workspace);
		 	//get python code
		 	var pyCode = Blockly.Python.workspaceToCode(workspace);
		 //put the code
		  document.getElementById('op-js').innerHTML = jsCode;
		  document.getElementById('op-py').innerHTML = pyCode;

		}//end update myUpdateFunction
		//add change listener for every time the workspace has a change
		workspace.addChangeListener(myUpdateFunction);
		</script>
		
		<!-- Insert this line above script imports  -->
		<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

		<script src="js/jquery.min.js"></script>
		
		<!-- Insert this line after script imports -->
		<script>if (window.module) module = window.module;</script>
		
		<script>
			
			
			$(document).ready(function(){
				freshWorkspace();//fresh
				$("#runBtn").prop('disabled', true);//disable run botton
			});
			
			let selPort = $('#select-port'); //set port selector select
			$('#get-port-btn').click(function (){
				selPort.empty();//empty it
				selPort.append(new Option('choose', 'nil'));//put pace holder
				
				ipc.send('getports', '');
				ipc.send('gethids', '');
				ipc.send('getblue', '');
			});

			document.querySelector('#scan-ble-btn').addEventListener('click', connect_ble);
			/*
			$('#scan-ble-btn').click(function (){
				
				connect_ble();
			});
			*/
			let myDevice; //the device
			let SEND_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';

			let SEND_SERVICE_CHARACTERISTIC = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
			let RES_SERVICE_CHARACTERISTIC = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

			let toggleChar;//toggle characteristic
			let notifyChar;//for receiving notifications

			const toggleButton = document.getElementById('toggle');
			
			function connect_ble()
			{	console.log("scanning");
			     navigator.bluetooth.requestDevice({
			    filters:
			      [
			        { name: 'Zee Ro machine' },
			        { services: [SEND_SERVICE] },
			      ]
			  })
			   /* .then(device => {
			      myDevice = device;
			      console.log (device);
			      return device.gatt.connect();
			    })
			    .then(server => server.getPrimaryService(SEND_SERVICE))
			    .then(service => service.getCharacteristics())
			    .then(chas => {
			      chas.forEach( ch => {
			          if(ch.uuid == SEND_SERVICE_CHARACTERISTIC)
			          {
			              toggleChar = ch;//set the one for sending
			          }
			          else if(ch.uuid == RES_SERVICE_CHARACTERISTIC)
			          {
			              notifyChar = ch;//set the one for receiv
			              //start notifications
			              notifyChar.startNotifications()
			              .then( note => { //the notification
			                  notifyChar.addEventListener('characteristicvaluechanged',handleNotif);
			              });
			          }//end else if
			       });
			     
			    })
			    */
			    .catch(error => {
			      console.error(error);
			    });

			}//end connect

			function doToggle() {
			  /* This function is called when user clicks on an effect radio button. */
			  console.log('toggle');
			  //send toggle message
			  var enc = new TextEncoder(); // always utf-8
			  let val = enc.encode("red_led");
			  toggleChar.writeValueWithResponse(val)
			  .then(function(res) {
			    console.log(toggleChar);

			   });

			}

			function handleNotif(){
			   const characteristic = event.target;
			  let val = new TextDecoder().decode(characteristic.value); // always utf-8
			  console.log(val);
			}

			document.querySelector('#toggle').addEventListener('click', doToggle);


			
			ipc.on('getports', (event, ports) => {
				console.log(ports);
				$.each(ports, function(index,port){
					//append the port values to the selector
					selPort.append(new Option(port.path+ ' '+ port.manufacturer, port.path));
				});
			});
			ipc.on('gethids', (event, ports) => {
				console.log(ports);
				
			});
	
			
			selPort.change(function()
			{
				let path =selPort.val();//the selected path
				if(path == 'nil')return;//placevalue selected. end here
				let reqData ={};//request data to be sent
				reqData.path = path;
				ipc.send('setport', reqData);
			});
			
			ipc.on('setport', (event, data) => {
				 
				  if(data=="success"){
					//enable run botton
					$("#runBtn").prop('disabled', false);
				  }//end if
			});


			
			
		</script>
		<script src="file_handling.js"></script>
	</body>
</html>